# SPDX-FileCopyrightText: 2022 Renaissance Computing Institute. All rights reserved.
# SPDX-FileCopyrightText: 2023 Renaissance Computing Institute. All rights reserved.
#
# SPDX-License-Identifier: GPL-3.0-or-later
# SPDX-License-Identifier: LicenseRef-RENCI
# SPDX-License-Identifier: MIT

---
{{ if eq .Values.configMapName "apsviz-thredds-prod-scripts" }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: "apsviz-thredds-prod-scripts"
data:

  Reanalysis.xml: |
    <?xml version="1.0" encoding="UTF-8"?>
    <catalog name="Coastal Reanalysis"
             xmlns="https://www.unidata.ucar.edu/namespaces/thredds/InvCatalog/v1.0"
             xmlns:xlink="http://www.w3.org/1999/xlink">
        <!--
          <contributor role="data manager">John Smith</contributor>
          <keyword>Atmospheric Chemistry</keyword>
          <publisher>
            <long_name vocabulary="DIF">Community Data Portal, National Center for Atmospheric Research, University Corporation for Atmospheric Research</long_name>
            <contact url="https://dataportal.ucar.edu" email="cdp@ucar.edu"/>
          </publisher>
        -->

        <service name="ThisAll" base="" serviceType="compound">
            <service name="odap" serviceType="OpenDAP" base="/thredds/dodsC/"/>
            <!--service name="dap4" serviceType="DAP4" base="/thredds/dap4/" /-->
            <service name="http" serviceType="HTTPServer" base="/thredds/fileServer/"/>
            <!--service name="wcs" serviceType="WCS" base="/thredds/wcs/" /-->
            <!--service name="wms" serviceType="WMS" base="/thredds/wms/" /-->
            <!--service name="ncss" serviceType="NetcdfSubset" base="/thredds/ncss/" /-->
            <!--service name="iso" serviceType="ISO" base="/thredds/iso/" /-->
            <service name="ncml" serviceType="NCML" base="/thredds/ncml/"/>
            <!--service name="uddc" serviceType="UDDC" base="/thredds/uddc/" /-->
        </service>

        <datasetScan
                name="ADCIRC"
                ID="ADCIRC"
                path="ReanalysisV2/ADCIRC"
                location="/projects/reanalysis/ADCIRC/ERA5/hsofs.V2">

            <metadata inherited="true">
                <serviceName>all</serviceName>
                <authority>renci.org</authority>
                <dataType>GRID</dataType>
                <documentation> Reanalysis ADCIRC solutions.</documentation>
            </metadata>
            <filter>
                <!--include wildcard="*"/-->
                <!--include wildcard="fort.15"/-->
                <!--include wildcard="*.nc"/-->
                <!--exclude wildcard="fort.22*"/-->
                <!--exclude wildcard="*.sh"/ -->
                <exclude wildcard="run.*"/>
                <exclude wildcard="fort.??"/>
                <exclude wildcard="initiallydry.63.nc"/>
                <exclude wildcard="inundationtime.63.nc"/>
                <exclude wildcard="endrisinginun.63.nc"/>
                <exclude wildcard="everdried.63.nc"/>
                <exclude wildcard="adcirc.log"/>
                <exclude wildcard="swaninit"/>
                <exclude wildcard="submit.*"/>
                <exclude wildcard="temp.1"/>
                <exclude wildcard="tide_fac.out"/>
                <exclude wildcard="slurm*"/>
                <exclude wildcard="*.sh"/>
                <exclude wildcard="*~"/>
                <exclude wildcard="*.py"/>
                <exclude wildcard="README"/>
                <exclude wildcard="*.txt"/>
                <exclude wildcard=".gitignore*"/>
                <exclude wildcard="Grids" atomic="false" collection="true"/>
                <exclude wildcard="bin" atomic="false" collection="true"/>
                <exclude wildcard="configs" atomic="false" collection="true"/>
                <exclude wildcard="common" atomic="false" collection="true"/>
                <exclude wildcard="Tides" atomic="false" collection="true"/>
                <exclude wildcard="TracksToRun" atomic="false" collection="true"/>
                <exclude wildcard="ec95d*" atomic="false" collection="true"/>
                <exclude wildcard="PE*" atomic="false" collection="true"/>
                <exclude wildcard=".git*" atomic="false" collection="true"/>
            </filter>
            <sort>
                <lexigraphicByName increasing="true"/>
            </sort>
        </datasetScan>

        <!--/dataset-->

    </catalog>

  aps2023.xml: |
    <?xml version="1.0" encoding="UTF-8"?>
    <catalog name="APS/NCFS/RENCI"
             xmlns="http://www.unidata.ucar.edu/namespaces/thredds/InvCatalog/v1.0"
             xmlns:xlink="http://www.w3.org/1999/xlink">

        <service name="all" base="" serviceType="compound">
            <service name="odap" serviceType="OpenDAP" base="/thredds/dodsC/"/>
            <!--service name="dap4" serviceType="DAP4" base="/thredds/dap4/" /-->
            <service name="http" serviceType="HTTPServer" base="/thredds/fileServer/"/>
            <service name="ncml" serviceType="NCML" base="/thredds/ncml/"/>
        </service>

        <datasetScan
                name="APS-2023"
                ID="APS-2023"
                path="2023"
                location="/projects/ncfs/opendap/data/2023">

            <metadata inherited="true">
                <serviceName>all</serviceName>
                <documentation type="summary"> APS Results for 2023</documentation>
            </metadata>
            <filesSort increasing="false"/>
            <filter>
                <include wildcard="*"/>
            </filter>

        </datasetScan>

    </catalog>

  asgs2021.xml: |
    <?xml version="1.0" encoding="UTF-8"?>
    <catalog name="ASGS/NCFS/RENCI"
             xmlns="http://www.unidata.ucar.edu/namespaces/thredds/InvCatalog/v1.0"
             xmlns:xlink="http://www.w3.org/1999/xlink">

        <service name="all" base="" serviceType="compound">
            <service name="odap" serviceType="OpenDAP" base="/thredds/dodsC/"/>
            <service name="dap4" serviceType="DAP4" base="/thredds/dap4/"/>
            <service name="http" serviceType="HTTPServer" base="/thredds/fileServer/"/>
            <service name="ncml" serviceType="NCML" base="/thredds/ncml/"/>
        </service>

        <datasetScan
                name="ASGS-2021"
                ID="ASGS-2021"
                path="2021"
                location="/projects/ncfs/opendap/data/2021">

            <metadata inherited="true">
                <serviceName>all</serviceName>
                <documentation type="summary"> ASGS Results for 2021</documentation>
            </metadata>

            <filter>
                <include wildcard="*"/>
            </filter>
        </datasetScan>


    </catalog>

  asgs2022.xml: |
    <?xml version="1.0" encoding="UTF-8"?>
    <catalog name="ASGS/NCFS/RENCI"
             xmlns="http://www.unidata.ucar.edu/namespaces/thredds/InvCatalog/v1.0"
             xmlns:xlink="http://www.w3.org/1999/xlink">

        <service name="all" base="" serviceType="compound">
            <service name="odap" serviceType="OpenDAP" base="/thredds/dodsC/"/>
            <service name="dap4" serviceType="DAP4" base="/thredds/dap4/"/>
            <service name="http" serviceType="HTTPServer" base="/thredds/fileServer/"/>
            <service name="ncml" serviceType="NCML" base="/thredds/ncml/"/>
        </service>

        <datasetScan
                name="ASGS-2022"
                ID="ASGS-2022"
                path="2022"
                location="/projects/ncfs/opendap/data/2022">

            <metadata inherited="true">
                <serviceName>all</serviceName>
                <documentation type="summary"> ASGS Results for 2022</documentation>
            </metadata>

            <filter>
                <include wildcard="*"/>
            </filter>
        </datasetScan>


    </catalog>

  catalog.xml: |
    <?xml version="1.0" encoding="UTF-8"?>
    <catalog name="APS Thredds Data Server"
             xmlns="http://www.unidata.ucar.edu/namespaces/thredds/InvCatalog/v1.0"
             xmlns:xlink="http://www.w3.org/1999/xlink">

        <service name="all" base="" serviceType="compound">
            <service name="odap" serviceType="OpenDAP" base="/thredds/dodsC/"/>
            <!--service name="dap4" serviceType="DAP4" base="/thredds/dap4/" /-->
            <service name="http" serviceType="HTTPServer" base="/thredds/fileServer/"/>
        </service>

        <dataset name="RENCI APS THREDDS Catalogs">

            <datasetScan
                    name="NCFS_CURRENT_TROPICAL"
                    ID="NCFS_CURRENT_TROPICAL"
                    path="NCFS_CURRENT_TROPICAL"
                    location="/projects/ncfs/opendap/data/NCFS_CURRENT_TROPICAL">

                <metadata inherited="true">
                    <serviceName>all</serviceName>
                    <documentation type="summary"> NCFS CURRENT TROPICAL Results</documentation>
                </metadata>

                <filter>
                    <include wildcard="*"/>
                </filter>

            </datasetScan>

            <datasetScan
                    name="NCFS_CURRENT_SYNOPTIC"
                    ID="NCFS_CURRENT_SYNOPTIC"
                    path="NCFS_CURRENT_SYNOPTIC"
                    location="/projects/ncfs/opendap/data/NCFS_CURRENT_DAILY">

                <metadata inherited="true">
                    <serviceName>all</serviceName>
                    <documentation type="summary"> NCFS CURRENT SYNOPTIC Results</documentation>
                </metadata>

                <filter>
                    <include wildcard="*"/>
                </filter>

            </datasetScan>

            <catalogRef xlink:href="aps2023.xml" xlink:title="RENCI APS 2023" name=""/>
            <catalogRef xlink:href="asgs2022.xml" xlink:title="RENCI APS 2022" name=""/>
            <catalogRef xlink:href="asgs2021.xml" xlink:title="RENCI APS 2021" name=""/>
            <!--catalogRef xlink:href="asgs2019.xml"                xlink:title="RENCI APS 2019"                   name=""/-->
            <!--catalogRef xlink:href="asgs2018.xml"                xlink:title="RENCI APS 2018"                   name=""/-->
        </dataset>

        <dataset name="RENCI Reanalysis Catalogs">
            <catalogRef xlink:href="Reanalysis.xml" xlink:title="RENCI Reanalysis" name=""/>
        </dataset>


        <!--dataset name="test"-->
        <!--catalogRef xlink:href="test.xml"  xlink:title="test"  name=""/-->
        <!--/dataset-->

    </catalog>

  threddsConfig.xml: |
    <?xml version="1.0" encoding="UTF-8"?>
    <threddsConfig>

        <!-- all options are commented out in standard install - meaning use default values -->
        <!-- see http://www.unidata.ucar.edu/projects/THREDDS/tech/reference/ThreddsConfigXMLFile.html -->
        <serverInformation>
            <name>THREDDS</name>
            <logoUrl>/thredds/renci-logo.png</logoUrl>
            <logoAltText>THREDDS</logoAltText>

            <abstract>Scientific Data</abstract>
            <keywords>meteorology, atmosphere, climate, ocean, earth science</keywords>

            <contact>
                <name>Brian Blanton</name>
                <organization>RENCI</organization>
                <email>bblanton@renci.org</email>
                <!--phone></phone-->
            </contact>
            <hostInstitution>
                <name>RENCI</name>
                <webSite>https://www.renci.org/</webSite>
                <logoUrl>/thredds/renci-logo.png</logoUrl>
                <logoAltText>RENCI</logoAltText>
            </hostInstitution>
        </serverInformation>

        <!--
        The <catalogRoot> element:
        For catalogs you don't want visible from the /thredds/catalog.xml chain
        of catalogs, you can use catalogRoot elements. Each catalog root config
        catalog is crawled and used in configuring the TDS.

        <catalogRoot>myExtraCatalog.xml</catalogRoot>
        <catalogRoot>myOtherExtraCatalog.xml</catalogRoot>
        -->

        <!--
         * Setup for generated HTML pages.
         *
         * NOTE: URLs may be absolute or relative, relative URLs must be relative
         * to the webapp URL, i.e., http://server:port/thredds/.
          -->
        <htmlSetup>
            <!--
             * CSS documents used in generated HTML pages.
             * The CSS document given in the "catalogCssUrl" element is used for all pages
             * that are HTML catalog views. The CSS document given in the "standardCssUrl"
             * element is used in all other generated HTML pages.
             * -->
            <standardCssUrl>tds.css</standardCssUrl>
            <catalogCssUrl>tdsCat.css</catalogCssUrl>
            <openDapCssUrl>tdsDap.css</openDapCssUrl>

            <!--
             * The Google Analytics Tracking code you would like to use for the
             * webpages associated with THREDDS. This will not track WMS or DAP
             * requests for data, only browsing the catalog.
            -->
            <googleTrackingCode></googleTrackingCode>

        </htmlSetup>

        <!--
          The <TdsUpdateConfig> element controls if and how the TDS checks
          for updates. The default is for the TDS to check for the current
          stable and development release versions, and to log that information
          in the TDS serverStartup.log file as INFO entries.

        <TdsUpdateConfig>
           <logVersionInfo>true</logVersionInfo>
        </TdsUpdateConfig>
        -->

        <!--
         The <CORS> element controls Cross-Origin Resource Sharing (CORS).
         CORS is a way to allow a website (such as THREDDS) to open up access
         to resources to web pages and applications running on a different domain.
         One example would be allowing a web-application to use fonts from
         a separate host. For TDS, this can allow a javascript app running on a
         different site to access data on a THREDDS server.
         For more information see: https://en.wikipedia.org/wiki/Cross-origin_resource_sharing
         The elements below represent defaults. Only the <enabled> tag is required
         to enable CORS. The default allowed origin is '*', which allows sharing
         to any domain.
        -->
        <CORS>
            <enabled>true</enabled>
            <maxAge>1728000</maxAge>
            <allowedMethods>GET</allowedMethods>
            <allowedHeaders>Authorization</allowedHeaders>
            <allowedOrigin>*</allowedOrigin>
        </CORS>

        <!--
         The <CatalogServices> element:
         - Services on local TDS served catalogs are always on.
         - Services on remote catalogs are set with the allowRemote element
         below. They are off by default (recommended).
         -->
        <CatalogServices>
            <allowRemote>false</allowRemote>
        </CatalogServices>

        <!--
        Configuring the CDM (netcdf-java library)
        see http://www.unidata.ucar.edu/software/netcdf-java/reference/RuntimeLoading.html

        <nj22Config>
          <ioServiceProvider class="edu.univ.ny.stuff.FooFiles"/>
          <coordSysBuilder convention="foo" class="test.Foo"/>
          <coordTransBuilder name="atmos_ln_sigma_coordinates" type="vertical" class="my.stuff.atmosSigmaLog"/>
          <typedDatasetFactory datatype="Point" class="gov.noaa.obscure.file.Flabulate"/>
        </nj22Config>
        -->

        <!--
        CDM uses the DiskCache directory to store temporary files, like uncompressed files.
        <DiskCache>
          <alwaysUse>false</alwaysUse>
          <scour>1 hour</scour>
          <maxSize>1 Gb</maxSize>
        </DiskCache>
        -->

        <!--
        Caching open NetcdfFile objects.
        default is to allow 50 - 100 open files, cleanup every 11 minutes
        <NetcdfFileCache>
          <minFiles>50</minFiles>
          <maxFiles>100</maxFiles>
          <scour>11 min</scour>
        </NetcdfFileCache>
        -->

        <!--
        The <HTTPFileCache> element:
        allow 10 - 20 open datasets, cleanup every 17 minutes
        used by HTTP Range requests.
        <HTTPFileCache>
          <minFiles>10</minFiles>
          <maxFiles>20</maxFiles>
          <scour>17 min</scour>
        </HTTPFileCache>
        -->

        <!--
        Writing GRIB indexes.
        <GribIndexing>
          <setExtendIndex>false</setExtendIndex>
          <alwaysUseCache>false</alwaysUseCache>
        </GribIndexing>
        -->

        <!--
        Persist joinNew aggregations to named directory. scour every 24 hours, delete stuff older than 90 days
        <AggregationCache>
          <scour>24 hours</scour>
          <maxAge>90 days</maxAge>
        </AggregationCache>
        -->

        <!--
        How to choose the template dataset for an aggregation. latest, random, or penultimate
        <Aggregation>
          <typicalDataset>penultimate</typicalDataset>
        </Aggregation>
        -->

        <!--
        The Netcdf Subset Service is off by default.
        -->
        <NetcdfSubsetService>
            <allow>true</allow>
            <scour>10 min</scour>
            <maxAge>-1 min</maxAge>
        </NetcdfSubsetService>

        <!--
        <Opendap>
          <ascLimit>50</ascLimit>
          <binLimit>500</binLimit>
          <serverVersion>opendap/3.7</serverVersion>
        </Opendap>
          -->

        <!--
        The WCS Service is off by default.
        Also, off by default (and encouraged) is operating on a remote dataset.
        -->
        <WCS>
            <allow>true</allow>
            <allowRemote>false</allowRemote>
            <scour>15 min</scour>
            <maxAge>30 min</maxAge>
        </WCS>

        <WMS>
            <allow>true</allow>
            <allowRemote>false</allowRemote>
            <maxImageWidth>2048</maxImageWidth>
            <maxImageHeight>2048</maxImageHeight>
        </WMS>

        <NCISO>
            <ncmlAllow>true</ncmlAllow>
            <uddcAllow>true</uddcAllow>
            <isoAllow>true</isoAllow>
        </NCISO>

        <!-- To enable ncSOS, uncomment and set to true
        <NCSOS>
          <allow>false</allow>
        </NCSOS>
        -->

        <!-- CatalogGen service is off by default.
        <CatalogGen>
          <allow>false</allow>
        </CatalogGen>
         -->

        <!-- DLwriter service is off by default.
             As is support for operating on remote catalogs.
        <DLwriter>
          <allow>false</allow>
          <allowRemote>false</allowRemote>
        </DLwriter>
         -->

        <!-- DqcService is off by default.
        <DqcService>
          <allow>false</allow>
        </DqcService>
         -->

        <!--
         Link to a Viewer application on the HTML page:
         <Viewer>my.package.MyViewer</Viewer>
         -->

        <!--
        Add a DataSource - essentially an IOSP with access to Servlet request parameters
        <datasetSource>my.package.DatsetSourceImpl</datasetSource>
        -->

        <!--
         set FeatureCollection logging
        <FeatureCollection>
           <RollingFileAppender>
             <MaxFileSize>1 MB</MaxFileSize>
             <MaxBackups>5</MaxBackups>
             <Level>INFO</Level>
           </RollingFileAppender>
        </FeatureCollection>
        -->


    </threddsConfig>

  tomcat-users.xml: |
    <?xml version='1.0' encoding='utf-8'?>
    <tomcat-users xmlns="http://tomcat.apache.org/xml"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://tomcat.apache.org/xml tomcat-users.xsd"
                  version="1.0">

        <role rolename="tdsConfig" description="can change THREDDS configuration files"/>
        <role rolename="tdsMonitor" description="can monitor log files with tdsMonitor program"/>
        <role rolename="tdsTrigger" description="can trigger feature collections, eg from tdm"/>

        {{ range $key, $value := .Values.tomcatUsers }}
        <user username={{ $value.name | quote }} password={{ $value.password | quote }} roles={{ $value.roles | quote }}/>
        {{ end }}
    </tomcat-users>
  {{ end }}